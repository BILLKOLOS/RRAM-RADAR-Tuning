import matplotlib as mpl, numpy as np, pandas as pd
import matplotlib.pyplot as plt
from matplotlib.ticker import FormatStrFormatter

# Chip number
chipnum = 1

# LaTEX quality figures 
mpl.rcParams.update(
    {
    'text.usetex': True,
    'pgf.texsystem': 'lualatex',
    'pgf.rcfonts': True
    }
)
plt.rc('font', family='serif', serif='Times', size=13)

# Setup figure
fig, ax = plt.subplots(figsize=(4,3))
plt.title('Pulses Required for Target Error')
plt.xlabel('Mean Pulses Required')
plt.ylabel('Error (\%)')
plt.tight_layout()

# Load SDR data
names = ['addr', 'nreads', 'nsets', 'nresets', 'rf', 'if', 'rlo', 'rhi', 'success', 'attempts1', 'attempts2']
if chipnum == 1:
    #fnames = ['../ispp/data/ispp-4wl-eval-chip1-6-6-20.csv', '../fppv/data/fppv-4wl-eval-chip1-6-6-20.csv', '../fppv/data/fppv-4wl-eval-chip1-6-6-20.csv', '../sdr/data/infopt/sdr-infopt-4wl-eval-chip1-6-8-20.csv']
    fnames = ['../ispp/data/ispp-4wl-eval-chip1-7-19-20.csv', '../fppv/data/fppv-wl0.070-bl5.80-sl0.30-0.30-7-19-20.csv', '../fppv/data/fppv-wl0.070-bl5.80-sl0.30-0.30-7-19-20.csv', '../sdr/data/sl-opt/sdr-wl0.070-bl0.40-sl0.05-0.20-7-19-20.csv']
if chipnum == 2:
    fnames = ['../ispp/data/ispp-4wl-eval-chip2-6-17-20.csv', '../fppv/data/fppv-4wl-eval-chip2-6-17-20.csv', '../fppv/data/fppv-4wl-eval-chip2-6-17-20.csv', '../sdr/data/infopt/sdr-infopt-4wl-eval-chip2-6-17-20.csv', '../sdr/data/infopt/sdr-wl0.06-bl0.80-sl0.30-7.00-6-22-20-1k.csv', '../sdr/data/infopt/sdr-wl0.06-bl0.80-sl0.30-7.00-6-22-20-6k.csv', '../sdr/data/infopt/sdr-wl0.06-bl0.80-sl0.30-7.00-6-22-20-11k.csv', '../sdr/data/infopt/sdr-wl0.06-bl0.80-sl0.30-7.00-6-22-20-20k.csv', '../sdr/data/infopt/sdr-wl0.06-bl0.80-sl0.30-7.00-6-22-20.csv', '../ispp/data/ispp-wl0.06-bl0.80-sl0.30-7.00-6-22-20.csv']
for i, fname in enumerate(fnames):
    data = pd.read_csv(fname, delimiter='\t', names=names, index_col=False)
    data['npulses'] = data['nsets'] + data['nresets'] - 1
    rlos = data['rlo'].unique()
    data['bin'] = data['rlo'].apply(lambda x: np.where(rlos == x)[0][0])
    data = data[data['bin'] != 7]
    if i == 1:
        if chipnum == 1:
            badaddrs = set([4774, 5221, 5673, 5813, 6314, 6414, 6422, 6534, 6578, 6602, 6625, 6633, 6654, 6730, 6745, 6746, 6761, 6843, 6859, 6866, 6934, 6964, 7115, 7122, 7129, 7130, 7144, 7145, 7198, 7242, 7250, 7325, 7370, 7528, 7572, 7574, 7582, 7589, 7642, 7656, 7702, 7724, 7746, 7761, 7777, 7791, 7792, 7814, 7815, 7830, 7837, 7868, 7883, 7889, 7898, 7912, 7943, 7957, 7966, 8033, 8055, 8086, 8093, 8100, 8101, 8183, 4121, 4181, 4208, 4218, 4231, 4244, 4284, 4358, 4367, 4380, 4395, 4411, 4433, 4441, 4457, 4492, 4496, 4520, 4528, 4570, 4575, 4577, 4653, 4658, 4666, 4683, 4713, 4719, 4737, 4774, 4779, 4794, 4810, 4817, 4819, 4825, 4831, 4856, 4872, 4879, 4929, 4978, 4985, 5013, 5031, 5044, 5077, 5078, 5082, 5083, 5095, 5129, 5133, 5166, 5197, 5198, 5202, 5210, 5221, 5254, 5255, 5276, 5283, 5303, 5352, 5384, 5442, 5466, 5470, 5496, 5510, 5516, 5526, 5534, 5535, 5564, 5571, 5639, 5647, 5662, 5672, 5673, 5677, 5705, 5706, 5744, 5746, 5752, 5754, 5797, 5811, 5813, 5819, 5834, 5856, 5878, 5886, 5925, 5935, 5973, 5986, 6025, 6053, 6074, 6076, 6089, 6173, 6181, 6219, 6288, 6303, 6309, 6314, 6342, 6371, 6393, 6414, 6422, 6425, 6468, 6470, 6528, 6534, 6551, 6578, 6602, 6625, 6633, 6636, 6641, 6654, 6656, 6679, 6685, 6717, 6730, 6732, 6745, 6746, 6754, 6761, 6762, 6768, 6769, 6843, 6845, 6859, 6860, 6861, 6862, 6866, 6875, 6882, 6889, 6896, 6913, 6922, 6934, 6957, 6960, 6964, 6974, 6995, 7013, 7049, 7095, 7115, 7122, 7129, 7130, 7136, 7138, 7144, 7145, 7166, 7175, 7198, 7199, 7229, 7242, 7250, 7264, 7325, 7328, 7334, 7370, 7393, 7401, 7446, 7447, 7455, 7468, 7521, 7528, 7531, 7532, 7572, 7574, 7582, 7589, 7598, 7599, 7642, 7644, 7656, 7680, 7688, 7702, 7724, 7732, 7746, 7759, 7761, 7763, 7777, 7786, 7791, 7792, 7803, 7814, 7815, 7830, 7832, 7833, 7836, 7837, 7844, 7848, 7868, 7876, 7883, 7889, 7898, 7912, 7914, 7923, 7930, 7943, 7957, 7966, 7983, 8010, 8014, 8026, 8032, 8033, 8035, 8055, 8079, 8086, 8093, 8094, 8100, 8101, 8139, 8170, 8183, ])
            print "Bad addrs:", len(badaddrs)
            data = data[~data['addr'].isin(badaddrs)]
        if chipnum == 2:
            badaddrs = [4105, 4111, 4117, 4119, 4137, 4160, 4161, 4167, 4202, 4203, 4238, 4260, 4261, 4273, 4279, 4280, 4332, 4412, 4450, 4455, 4456, 4511, 4568, 4579, 4608, 4609, 4620, 4642, 4654, 4669, 4672, 4678, 4680, 4692, 4697, 4698, 4708, 4717, 4723, 4741, 4789, 4801, 4809, 4815, 4827, 4835, 4842, 4844, 4845, 4853, 4890, 4895, 4897, 4898, 4911, 4914, 4916, 4919, 4922, 4923, 4929, 4945, 4957, 4960, 4963, 4966, 4983, 4996, 5017, 5039, 5057, 5071, 5075, 5102, 5110, 5143, 5151, 5159, 5160, 5161, 5193, 5197, 5205, 5206, 5209, 5213, 5214, 5219, 5237, 5242, 5257, 5260, 5270, 5275, 5282, 5288, 5290, 5300, 5301, 5307, 5310, 5325, 5328, 5329, 5358, 5388, 5396, 5398, 5406, 5412, 5415, 5417, 5423, 5426, 5439, 5444, 5447, 5454, 5457, 5459, 5477, 5493, 5494, 5508, 5510, 5511, 5518, 5523, 5563, 5583, 5592, 5604, 5610, 5626, 5632, 5641, 5659, 5665, 5669, 5670, 5680, 5690, 5709, 5711, 5712, 5715, 5717, 5734, 5735, 5750, 5756, 5758, 5759, 5764, 5779, 5785, 5813, 5815, 5816, 5817, 5820, 5839, 5845, 5860, 5874, 5877, 5890, 5892, 5899, 5902, 5922, 5927, 5938, 5955, 5959, 5965, 5974, 5980, 5982, 6001, 6010, 6012, 6014, 6018, 6019, 6035, 6039, 6051, 6054, 6073, 6104, 6107, 6128, 6139, 6150, 6151, 6160, 6201, 6209, 6219, 6236, 6240, 6243, 6262, 6266, 6268, 6290, 6292, 6350, 6355, 6363, 6377, 6380, 6392, 6402, 6403, 6408, 6421, 6433, 6448, 6450, 6452, 6464, 6477, 6484, 6497, 6506, 6543, 6552, 6566, 6569, 6572, 6579, 6593, 6597, 6602, 6625, 6627, 6639, 6664, 6677, 6693, 6715, 6726, 6727, 6740, 6751, 6775, 6787, 6793, 6803, 6824, 6841, 6843, 6851, 6855, 6864, 6878, 6893, 6918, 6919, 6944, 6964, 6977, 6983, 7008, 7029, 7076, 7082, 7098, 7102, 7107, 7114, 7116, 7128, 7134, 7142, 7146, 7158, 7182, 7202, 7213, 7221, 7222, 7228, 7241, 7248, 7258, 7261, 7263, 7269, 7270, 7288, 7300, 7310, 7337, 7357, 7374, 7385, 7416, 7428, 7433, 7437, 7438, 7462, 7497, 7507, 7522, 7524, 7525, 7529, 7542, 7557, 7558, 7561, 7567, 7571, 7587, 7626, 7632, 7633, 7635, 7643, 7667, 7687, 7691, 7696, 7713, 7715, 7731, 7736, 7737, 7741, 7745, 7747, 7773, 7785, 7802, 7816, 7819, 7860, 7870, 7882, 7887, 7899, 7913, 7922, 7924, 7929, 7933, 7945, 7949, 7994, 8009, 8019, 8024, 8028, 8038, 8074, 8103, 8105, 8114, 8120, 8130, 8132, 8148, 8165, 8179, 8181, 8185, 8197, 8202, 8204, 8206, 8209, 8214, 8218, 8228, 8235, 8236, 8239, 8245, 8250, 8253, 8256, 8259, 8262, 8263, 8265, 8266, 8272, 8273, 8275, 8277, 8289, 8297, 8299, 8301, 8311, 8314, 8317, 8323, 8342, 8344, 8348, 8353, 8357, 8372, 8382, 8395, 8400, 8411, 8412, 8422, 8428, 8432, 8438, 8440, 8442, 8445, 8461, 8465, 8495, 8500, 8510, 8514, 8515, 8517, 8527, 8536, 8539, 8549, 8550, 8560, 8561, 8572, 8580, 8600, 8613, 8617, 8621, 8626, 8628, 8638, 8645, 8652, 8658, 8664, 8666, 8667, 8670, 8672, 8679, 8684, 8685, 8693, 8698, 8705, 8706, 8709, 8716, 8729, 8731, 8741, 8758, 8760, 8762, 8763, 8764, 8766, 8772, 8784, 8787, 8796, 8799, 8800, 8801, 8819, 8824, 8826, 8830, 8834, 8841, 8851, 8860, 8865, 8877, 8881, 8886, 8889, 8891, 8896, 8899, 8909, 8910, 8915, 8916, 8917, 8923, 8926, 8933, 8946, 8948, 8951, 8952, 8954, 8956, 8964, 8966, 8972, 8973, 8974, 8978, 8982, 8983, 8997, 8998, 9001, 9003, 9005, 9012, 9014, 9019, 9023, 9047, 9049, 9061, 9068, 9071, 9072, 9074, 9075, 9078, 9081, 9085, 9092, 9094, 9101, 9103, 9107, 9114, 9115, 9116, 9117, 9123, 9128, 9139, 9144, 9150, 9156, 9157, 9164, 9165, 9166, 9167, 9175, 9190, 9193, 9203, 9214, 9215, 9218, 9225, 9227, 9228, 9232, 9234, 9235, 9238, 9239, 9240, 9252, 9253, 9258, 9259, 9260, 9263, 9267, 9282, 9285, 9286, 9290, 9291, 9292, 9293, 9311, 9316, 9321, 9322, 9329, 9332, 9334, 9335, 9338, 9340, 9346, 9353, 9355, 9363, 9366, 9382, 9402, 9403, 9406, 9416, 9420, 9441, 9442, 9443, 9446, 9456, 9457, 9461, 9463, 9470, 9471, 9472, 9474, 9482, 9484, 9485, 9486, 9488, 9490, 9491, 9500, 9503, 9516, 9517, 9519, 9525, 9526, 9537, 9558, 9559, 9561, 9563, 9566, 9567, 9573, 9587, 9591, 9592, 9595, 9603, 9604, 9607, 9613, 9622, 9623, 9633, 9635, 9642, 9643, 9644, 9645, 9650, 9651, 9655, 9662, 9665, 9668, 9670, 9673, 9678, 9681, 9684, 9686, 9687, 9692, 9702, 9726, 9729, 9737, 9740, 9741, 9742, 9745, 9746, 9750, 9751, 9770, 9774, 9784, 9785, 9788, 9790, 9793, 9795, 9803, 9804, 9815, 9820, 9826, 9828, 9835, 9844, 9849, 9850, 9851, 9852, 9854, 9858, 9869, 9870, 9871, 9872, 9879, 9880, 9882, 9883, 9890, 9897, 9905, 9913, 9917, 9918, 9933, 9936, 9937, 9942, 9947, 9948, 9957, 9963, 9964, 9965, 9969, 9973, 9977, 9979, 9981, 9984, 9992, 9993, 9998, 10005, 10015, 10017, 10032, 10033, 10036, 10038, 10039, 10045, 10052, 10057, 10060, 10061, 10069, 10071, 10072, 10074, 10076, 10077, 10078, 10089, 10092, 10104, 10106, 10111, 10114, 10115, 10121, 10123, 10127, 10130, 10131, 10134, 10145, 10146, 10153, 10161, 10170, 10174, 10179, 10181, 10184, 10185, 10194, 10197, 10200, 10204, 10215, 10230, 10232, 10233, 10237, 10254, 10256, 10261, 10265, 10287, 10289, 10292, 10297, 10303, 10304, 10306, 10310, 10315, 10324, 10334, 10343, 10347, 10348, 10377, 10395, 10402, 10409, 10410, 10412, 10420, 10433, 10437, 10446, 10451, 10459, 10466, 10475, 10478, 10483, 10485, 10486, 10488, 10503, 10506, 10532, 10533, 10534, 10538, 10565, 10568, 10573, 10576, 10586, 10589, 10590, 10612, 10623, 10636, 10646, 10665, 10667, 10671, 10677, 10694, 10701, 10715, 10731, 10742, 10744, 10754, 10779, 10780, 10784, 10788, 10809, 10823, 10825, 10830, 10833, 10840, 10842, 10844, 10847, 10849, 10853, 10866, 10867, 10873, 10875, 10877, 10879, 10882, 10884, 10885, 10889, 10893, 10923, 10925, 10951, 10963, 10970, 10974, 10990, 10994, 11000, 11005, 11011, 11013, 11018, 11020, 11022, 11027, 11039, 11041, 11047, 11057, 11066, 11070, 11071, 11090, 11117, 11121, 11122, 11123, 11131, 11138, 11142, 11144, 11151, 11159, 11165, 11167, 11171, 11173, 11174, 11175, 11184, 11185, 11188, 11190, 11196, 11201, 11202, 11214, 11228, 11233, 11237, 11243, 11254, 11259, 11277, 11287, 11300, 11306, 11311, 11321, 11323, 11326, 11329, 11337, 11338, 11348, 11349, 11353, 11354, 11355, 11356, 11367, 11371, 11373, 11386, 11395, 11400, 11417, 11425, 11426, 11427, 11436, 11444, 11445, 11453, 11456, 11469, 11491, 11492, 11502, 11503, 11507, 11514, 11520, 11525, 11532, 11534, 11536, 11539, 11540, 11543, 11555, 11563, 11564, 11568, 11577, 11581, 11582, 11592, 11593, 11595, 11596, 11605, 11612, 11615, 11616, 11617, 11627, 11641, 11642, 11645, 11650, 11651, 11654, 11657, 11666, 11668, 11682, 11684, 11690, 11692, 11703, 11715, 11716, 11719, 11721, 11722, 11724, 11726, 11740, 11743, 11748, 11754, 11757, 11770, 11771, 11782, 11790, 11799, 11802, 11806, 11807, 11817, 11822, 11827, 11829, 11837, 11841, 11843, 11847, 11848, 11850, 11851, 11857, 11858, 11861, 11864, 11872, 11873, 11881, 11883, 11889, 11895, 11913, 11914, 11915, 11922, 11939, 11941, 11944, 11948, 11951, 11958, 11966, 11967, 11969, 11973, 11981, 11990, 12006, 12010, 12013, 12020, 12026, 12029, 12038, 12040, 12042, 12045, 12056, 12060, 12066, 12074, 12075, 12076, 12078, 12079, 12085, 12086, 12092, 12093, 12096, 12104, 12120, 12121, 12127, 12136, 12137, 12139, 12141, 12143, 12144, 12155, 12161, 12162, 12166, 12174, 12189, 12192, 12197, 12201, 12202, 12217, 12226, 12235, 12237, 12241, 12242, 12244, 12245, 12250, 12253, 12267, 12269, 12280, 12282, 12283, 4097, 4106, 4138, 4143, 4148, 4151, 4175, 4182, 4215, 4227, 4234, 4235, 4321, 4325, 4328, 4344, 4375, 4386, 4387, 4391, 4393, 4398, 4413, 4430, 4431, 4434, 4444, 4454, 4472, 4518, 4523, 4524, 4526, 4527, 4536, 4550, 4552, 4563, 4574, 4592, 4593, 4617, 4628, 4629, 4644, 4666, 4677, 4681, 4687, 4695, 4699, 4705, 4706, 4709, 4715, 4729, 4737, 4740, 4747, 4750, 4756, 4768, 4773, 4775, 4780, 4781, 4783, 4795, 4806, 4813, 4833, 4850, 4851, 4862, 4863, 4868, 4884, 4885, 4938, 4941, 4984, 4990, 5032, 5036, 5040, 5047, 5055, 5064, 5080, 5085, 5095, 5096, 5111, 5124, 5131, 5142, 5149, 5156, 5157, 5162, 5170, 5174, 5176, 5190, 5207, 5230, 5236, 5240, 5245, 5248, 5249, 5254, 5294, 5324, 5344, 5348, 5350, 5387, 5394, 5420, 5424, 5427, 5440, 5442, 5450, 5469, 5472, 5489, 5572, 5574, 5575, 5613, 5617, 5620, 5621, 5631, 5637, 5638, 5645, 5657, 5678, 5699, 5720, 5721, 5733, 5740, 5741, 5761, 5777, 5784, 5799, 5800, 5838, 5841, 5856, 5864, 5865, 5868, 5870, 5882, 5886, 5933, 5956, 6033, 6036, 6067, 6077, 6078, 6080, 6082, 6138, 6186, 6194, 6220, 6237, 6238, 6239, 6259, 6272, 6293, 6305, 6332, 6342, 6349, 6352, 6368, 6370, 6374, 6376, 6384, 6385, 6410, 6432, 6461, 6472, 6480, 6482, 6521, 6534, 6560, 6568, 6589, 6604, 6621, 6622, 6624, 6648, 6657, 6668, 6691, 6701, 6712, 6716, 6722, 6734, 6770, 6779, 6795, 6836, 6846, 6848, 6857, 6875, 6881, 6920, 6954, 6957, 6968, 6974, 6988, 6999, 7013, 7017, 7018, 7048, 7084, 7085, 7091, 7122, 7127, 7131, 7133, 7139, 7144, 7149, 7157, 7163, 7170, 7178, 7217, 7238, 7245, 7253, 7272, 7276, 7280, 7299, 7302, 7304, 7321, 7336, 7345, 7351, 7355, 7358, 7359, 7372, 7383, 7392, 7397, 7409, 7410, 7506, 7517, 7521, 7563, 7603, 7622, 7625, 7636, 7646, 7649, 7652, 7656, 7663, 7673, 7674, 7695, 7698, 7700, 7726, 7727, 7735, 7742, 7762, 7768, 7789, 7796, 7826, 7839, 7858, 7879, 7883, 7886, 7888, 7892, 7898, 7901, 7902, 7917, 7920, 7934, 7960, 7982, 7990, 7993, 8004, 8007, 8039, 8063, 8071, 8073, 8095, 8104, 8106, 8115, 8155, 8163, 8180, 8183, 8184, 8193, 8210, 8211, 8217, 8249, 8261, 8271, 8280, 8282, 8285, 8287, 8302, 8305, 8307, 8321, 8329, 8330, 8341, 8354, 8355, 8362, 8368, 8375, 8376, 8378, 8381, 8385, 8390, 8391, 8398, 8399, 8405, 8415, 8417, 8429, 8431, 8433, 8434, 8436, 8441, 8448, 8470, 8474, 8480, 8485, 8488, 8493, 8504, 8505, 8511, 8513, 8525, 8526, 8532, 8538, 8553, 8554, 8557, 8565, 8566, 8574, 8578, 8584, 8587, 8591, 8593, 8594, 8599, 8608, 8609, 8615, 8618, 8623, 8624, 8629, 8633, 8637, 8642, 8648, 8651, 8660, 8661, 8663, 8669, 8677, 8691, 8700, 8701, 8702, 8704, 8710, 8719, 8720, 8728, 8736, 8739, 8740, 8752, 8754, 8759, 8769, 8776, 8780, 8782, 8783, 8786, 8798, 8803, 8806, 8807, 8814, 8815, 8816, 8818, 8835, 8836, 8837, 8849, 8856, 8867, 8873, 8875, 8876, 8884, 8890, 8905, 8913, 8921, 8929, 8930, 8938, 8939, 8940, 8941, 8949, 8959, 8960, 8981, 8995, 9000, 9006, 9009, 9010, 9020, 9024, 9031, 9032, 9033, 9045, 9053, 9057, 9060, 9067, 9070, 9083, 9088, 9104, 9106, 9109, 9110, 9111, 9122, 9124, 9130, 9133, 9136, 9137, 9140, 9145, 9148, 9154, 9158, 9160, 9161, 9162, 9168, 9170, 9171, 9174, 9178, 9181, 9182, 9183, 9184, 9192, 9195, 9197, 9201, 9202, 9211, 9213, 9217, 9219, 9221, 9237, 9251, 9254, 9256, 9261, 9265, 9277, 9278, 9289, 9294, 9303, 9310, 9312, 9317, 9318, 9320, 9323, 9328, 9345, 9348, 9358, 9359, 9360, 9374, 9376, 9381, 9389, 9393, 9401, 9409, 9413, 9414, 9415, 9418, 9421, 9422, 9426, 9427, 9431, 9439, 9444, 9445, 9453, 9460, 9462, 9473, 9475, 9476, 9494, 9496, 9498]
            print "Bad addrs:", len(badaddrs)
            data = data[~data['addr'].isin(badaddrs)]

    pulses = []
    bers = []
    for maxpulses in range(5000, 0, -1):
        data['success'] = data['success'].astype(bool) & (data['npulses'] <= maxpulses)
        data['npulses'] = data['npulses'].clip(upper=maxpulses)
        pulses.append(data['npulses'].mean())
        bers.append(1-data['success'].mean())
        # if maxpulses == 200:
        #     pulses.append(15)
        #     bers.append(1-data['success'].mean())
    bers = np.array(bers)*100
    if i != 1:
        plt.semilogy(pulses, bers)
    else:
        plt.semilogy(pulses, bers, '--')

    argerr = np.argmin(np.abs(bers - 1))
    print fname
    print pulses[argerr], bers[argerr]
    print pulses[argerr-1], bers[argerr-1]
    if i != 2:
        plt.annotate('%.2f' % pulses[argerr-1], xy=(pulses[argerr-1], bers[argerr-1]), xytext=(pulses[argerr-1]+20-40*i, 2), arrowprops=dict(facecolor='black', shrink=0.1, width=1, headwidth=3, headlength=5), fontsize=11, horizontalalignment='center', verticalalignment='center')

plt.semilogy([0, 200], [1, 1], ':')
plt.legend(['ISPP', 'FPPV (-6\% cells)', 'FPPV (orig)', 'SDCFC'], ncol=1, columnspacing=1, handletextpad=0.5, borderpad=0.2, prop={'size': 10})
plt.xlim(0, 200)
plt.ylim(0.5, 100)
ax.xaxis.set_major_formatter(FormatStrFormatter('%d'))
ax.yaxis.set_major_formatter(FormatStrFormatter('%d'))
plt.tight_layout()
plt.show()
